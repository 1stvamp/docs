<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Juju Documentation - Writing a Charm</title>
  <link href='https://fonts.googleapis.com/css?family=Ubuntu:400,300,300italic,400italic,700,700italic|Ubuntu+Mono' rel='stylesheet' type='text/css' />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/reset.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/960.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/base.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/home-new.css" />
  <link rel='stylesheet' id='stacktack-css'  href='//juju.ubuntu.com/wp-content/plugins/stacktack/css/stacktack.min.css?ver=3.4.2' type='text/css' media='all' />
  <link href="css/main.css?1375975745" rel="stylesheet" type="text/css"/>

  <!--[if lt IE 9]>
  <script type="text/javascript" src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
  <body class="resources">
    <header class="global clearfix" role="banner">
  <div class="header-navigation">
    <div>
      <nav role="navigation">
        <ul>
          <li class="page_item page-item-6"><a href="https://juju.ubuntu.com/">Home</a></li>
          <li class="page_item page-item-7"><a href="https://juju.ubuntu.com/get-started/">Get started</a></li>
          <li class="page_item page-item-9 current_page_item"><a href="https://juju.ubuntu.com/resources/">Resources</a></li>
          <li class="page_item page-item-13"><a href="https://juju.ubuntu.com/community/">Community</a></li>
          <li class="page_item page-item-3688"><a href="https://juju.ubuntu.com/charm-store/">Charm Store</a></li>
          <li class="page_item page-item-3691"><a href="https://juju.ubuntu.com/events/">Events</a></li>
          <li class="page_item page-item-4474"><a href="https://juju.ubuntu.com/charm-championship/">Charm Championship</a></li>
          <li class="page_item page-item-4249"><a href="https://juju.ubuntu.com/survey/">Survey</a></li>
          <li>
            <form id="form-search" method="get" action="https://juju.ubuntu.com/">
              <fieldset>
                <input id="input-search" type="text" name="s" value="Search" />
              </fieldset>
            </form>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="header-content">
    <div class="clearfix">
      <img src="https://juju.ubuntu.com/wp-content/themes/juju-website/img/arrow-nav.png" width="9" height="5" style="left:894px; display: block;" class="arrow-nav">
      <div class="header-navigation-secondary"></div>
      <div class="header-image"></div>
      <h1>Resources</h1>
      <h2>A collection of some of the most important online references for Juju users and developers.</h2>
    </div>
  </div>
</header>

    <section id="content" class="container-12">
      <div class="grid-12 doc-container">
        <div id="navlinks" class="grid-3 doc-navigation">LINKS</div>
        <div class="grid-9 doc-content">
          <article>
<h1>Your First charm starts here!</h1>
<p>Okay, so you have read up all the background info on what a charm is, how it works, and what parts of the charm do what, now it is time to dust off your favourite code editor (no arguments please) and get charming!</p>
<p>For this example, we are imagining that we want to create a charm for <a href="http://vanillaforums.org/" >the Vanilla forum software</a></p>

<span class="number"> 1 </span>
          <div class="step" id="step01">
          <h2>Prepare yourself</h2>
          <p>As we are writing a charm, it makes sense to create it in a local charm repository (see how to deploy from a local repository <a href="./charms-deploying.html" target="#local">here</a>) to make it easy to test in your Juju environment.</p>
          <p>Go to your home directory (or wherever is appropriate and make the appropriate file structure:</p>
          <pre>cd ~<br>mkdir -p charms/precise/vanilla </pre>
          
          </div>

<span class="number" > 2 </span>
          <div class="step" id="step02">
          <h2>Create the README file</h2>
          <p>Fire up your text editor and create a readme file.</p>
          <p>This step is especially important if you intend making your charm public, but it is very useful even if your charm will only ever be seen by you. The README is a good place to make nots about how the charm works, what information it expects to communicate and how.</p>
          <p>Although a plain text file is fine, you can also write your README file using Markdown (in which case use the .md suffix). The advantage of this, other than it looks quite neat, is that the Charm Store will render Mardown properly online, so your README will look and read better.</p>
          <p>Here is a quick example README file for our Vanilla charm:</p>
          <pre class="prettyprint lang-yaml">
# Overview

Vanilla is a powerful open source web-based forum. This charm will deploy the forum software and connect it to a running MySQL database. This charm will install the Vanilla files in /var/www/vanilla/

# Installation

To deploy this charm you will need at a minimum: a cloud environment, working Juju installation and a successful bootstrap. Once bootstrapped, deploy the MySQL charm and then this Vanilla charm:

    juju deploy mysql
    juju deploy vanilla

Add a relation between the two of them:

    juju add-relation mysql vanilla

And finally expose the Vanilla service:

    juju expose vanilla</pre>

          <p>Obviously, you can include any useful info you wish.</p>
          </div>
          
<span class="number" > 3 </span>
          <div class="step" id="step03">
          <h2>Make some metadata.yaml</h2>
          <p>The <strong>metadata.yaml</strong> file is really important. This is the file that Juju reads to find out what a charm is, what it does and what it needs to do it.</p>
          <p>The yaml syntax is at once simple, but exact, so if you have any future problems with Juju not recognising your charm, this is the first port of call! the information is stored in simple <span class="pre">&LT;key&GT; : &LT;value&GT;</span> associations. The first four are pretty self explanitory:</p>
          <pre class="prettyprint lang-basic">
name: vanilla
summary: Vanilla is an open-source, pluggable, multi-lingual forum.
maintainer: Your Name &lt;your@email.tld&gt;
description: |
  Vanilla is designed to deploy and grow small communities to scale. 
  This charm deploys Vanilla Forums as outlined by the Vanilla Forums
  installation guide.
</pre>
          <p>The summary should be a brief description of the service being deployed, whereas the description can go into more detail.</p>
          <p>The next value to define is the category. This is primarily for organising the charm in the charm store. the available categories are:</p>
          <ul>
          <li><strong>databases -</strong> MySQL, Postgres, couchDB, etc.</li>
          <li><strong>file-servers - </strong>storage apps such as ceph</li>
          <li><strong>applications -</strong>applications like mediawiki, wordpress</li>
          <li><strong>cache-proxy - </strong>services such as haproxy and Varnish.</li>
          <li><strong>app-servers - </strong>infrastructure services like Apache and Tomcat</li>
          <li><strong>miscellaneous - </strong>anything which doesn't neatly fit anywhere above.</li>
          </ul>
          <p>Your charm can belong to more than one category, though in almost all cases it should be in just one. Because there could be more than one entry here, the yaml is formatted as a list:</p>
          <pre class="prettyprint lang-yaml">categories:<br>  - applications</pre>
          <p>Next we need to explain which services are actually provided by this service. This is done using an indent for each service provided, followed by a description of the interface. The interface name is important as it can be used elsewhere in the environment to relate back to this charm, e.g. when writing hooks.</p>
          <p>Our Vanilla charm is a web-based service which exposes a simple http interface:</p> 
          <pre class="prettyprint lang-yaml">provides:<br>  website:<br>    interface: http</pre>
          <p>The name given here is important as it will be used in hooks that we write later, and the interface name will be used by other charms which may want to relate to this one.</p>
          <p>Similarly we also need to provide a "requires" section. In this case we need a database. Checking out the metadata of the MySQL charm we can see that it provides this via the interface name "mysql", so we can use this name in our metadata.</p>
          <p>The final file should look like this:</p>
          <pre class="prettyprint lang-yaml">
name: vanilla
summary: Vanilla is an open-source, pluggable, themeable, multi-lingual forum.
maintainer: Your Name &lt;your@email.tld&gt;
description: |
  Vanilla is designed to deploy and grow small communities to scale. 
  This charm deploys Vanilla Forums as outlined by the Vanilla Forums installation guide.
categories:
  - applications
provides:
  website:
    interface: http
requires:
  database:
    interface: mysql</pre>
          <p>
          <p>For some charms you will want a "peers" section also. This follows the same format, and its used for optional connections, such as you might use for interconnecting services in a cluster
          </p>
          

          </div>         
<span class="number" > 4 </span>
          <div class="step" id="step04">
          <h2>Writing hooks</h2>
          <p>As you will know from your through reading of <a href="./authors-charm-anatomy.html"> the anatomy of a charm</a> The hooks are the important scripts that actually do things. You can write hooks in whatever language you can reasonably expect to execute on an Ubuntu server</p>
          <p>For our charm, the hooks we will need to create are:</p>
          <ul>
          <li>start - for when the service needs to be started.</li>
          <li>stop - for stopping it again.</li></ul>
          <li>install - for actually fetching and installing the Vanilla code.</li>
          <li>database-relation-changed - this will run when we connect (or re-connect, or disconnect) our service to the MySQL database. This hook will need to manage this connection.</li>
          <li>website-relation-joined - this will run when/if a service connects to our charm.</li>
          </ul>
          <p>So first up we should create the hooks directory, and start creating our first hook:</p>
          <pre>mkdir hooks<br>cd hooks<br>vi start</pre>
          <p>(Use your favourite editor, naturally - no flames please)</p>
          <p>We have started with the start hook, because it is pretty simple. Our charm will be served up by apache, so all we need to do to start the service is make sure apache is running:</p>
          <pre class="prettyprint lang-bash">#!/bin/bash<br>set -e<br>service apache2 restart</pre>
          <p>A bit of explanation for this one. As we are writing in bash, and we need the files to be executable, we start with a hash-bang line indicating this is a bash file.
          the <span class="pre">set -e</span> line means that if any subsequent command returns false (non-zero) the script will stop and raise an error - this is important so that Juju can work out if things are running properly.
          </p>
          <p>The final line starts the apache webservice, thus also starting our Vanilla service. Why do we call 'restart'? One of the important ideas behind hooks is that they should be 'idempotent'. That means that the opration should be capable of being run many times without changing the intended result (basically). in this case, we don't want an error if apache is actually already running, we just want it to run and reload any config changes.</p>
          <p>Once you have saved the file, it is important to make sure that you set it to be executable too!</p>
          <pre>chmod +x start</pre>
          <p>With the easy bit out of the way, how about the install hook? This needs to install any dependencies, fetch the actual software and do any other config and service jobs that need to happen. here is an example for our vanilla charm:</p>
                    
<pre class="prettyprint">
#!/bin/bash

set -e # If any command fails, stop execution of the hook with that error

apt-get install -y apache2 php5-cgi php5-mysql curl php5-gd wget libapache2-mod-php5

dl="https://github.com/vanillaforums/Garden/archive/Vanilla_2.0.18.8.tar.gz"

# Grab Vanilla from upstream.
juju-log "Fetching $dl"
wget "$dl" -O /tmp/vanilla.tar.gz

# IDEMPOTENCY is very important in all charm hooks, even the install hook.
if [ -f /var/www/vanilla/conf/config.php ]; then
  cp /var/www/vanilla/conf/config.php /tmp/
  rm -rf /var/www/vanilla
fi

# Extract to a known location
juju-log "Extracting Vanilla"
tar -xvzf /tmp/vanilla.tar.gz -C /var/www/
mv /var/www/Garden-Vanilla* /var/www/vanilla

if [ -f /tmp/config.php ]; then
  mv /tmp/config.php /var/www/vanilla/conf/
fi

chmod -R 777 /var/www/vanilla/conf /var/www/vanilla/uploads /var/www/vanilla/cache

juju-log "Creating apache2 configuration"
cat &lt;&lt;EOF $gt; /etc/apache2/sites-available/vanilla
&lt;VirtualHost *:80&gt;
  ServerAdmin webmaster@localhost
  DocumentRoot /var/www/vanilla
  
  &lt;Directory /var/www/vanilla&gt;
    Options Indexes FollowSymLinks MultiViews
    AllowOverride All
    Order allow,deny
    allow from all
  &lt;/Directory&gt;

  ErrorLog \${APACHE_LOG_DIR}/vanilla.log
  LogLevel warn

  CustomLog \${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;
EOF

a2dissite 000-default
a2ensite vanilla

service apache2 reload

juju-log "Files extracted, waiting for other events before we do anything else!"
</pre>
          <p>We aren't going to go for a line-by-line explanation of that, but there are a few things worth noting</p>
          <p>Firstly, note the use of the -y option of the apt-get command. this assumes a 'yes' answer to any questions and removes any manual install options (e.g. services that run config dialogs when they install</p>
          <p>In our script, we are fetching the tarball of the Vanilla software. In these cases, it is obviously always better to point to a specific, permanent link to a version of the software. </p>         
          <p>Also, you will notice that we have used the <span class="pre">juju-log</span> command. This basically spits messages out into the juju log, which is very useful for testing and debugging. We will cover that in more detail later in this walkthrough. </p>
          <p>The next step is to create the relationship hooks... </p>
          <p>We know from our metadata that we have a connection called 'database', so we can have hooks that relate to that. Note that we don't have to create hooks for all possible events if they are not required - if Juju doesn't find a hook file for a paticular action, it just assumes everything is okay and carries on. It is up to you to decide which events require a hook.</p>
          <p>Let's take a stab at the 'database-relation-changed' hook:</p>
          <pre class="prettyprint">#!/bin/bash

set -e # If any command fails, stop execution of the hook with that error

db_user=`relation-get user`
db_db=`relation-get database`
db_pass=`relation-get password`
db_host=`relation-get private-address`

if [ -z "$db_db" ]; then
  juju-log "No database information sent yet. Silently exiting"
  exit 0
fi

vanilla_config="/var/www/vanilla/conf/config.php"

cat <<EOF > $vanilla_config
&LT;?php if (!defined('APPLICATION')) exit();

\$Configuration['Database']['Host'] = '$db_host';
\$Configuration['Database']['Name'] = '$db_db';
\$Configuration['Database']['User'] = '$db_user';
\$Configuration['Database']['Password'] = '$db_pass';
EOF

juju-log "Make the application port available, now that we know we have a site to expose"

open-port 80

</pre>

<p>You will notice that this script uses the backticked command <span class="pre">relation-get</span>. This is a Juju helper command that fetches the named values from the corresponding hook on the service we are connecting to.
Usually there will be some indication of what these values are, but you can always inspect the corresponding hoks to find out. In this case we know that when connected, the MySQL charm will create a database and generate random values for things like a username and password.</p>
<p>These values will all be set at one time, so the next little bit of script just checks one value to see if it exists - if not the corresponding charm hasn't set the values yet.</p>
<p>When it has the values we can use these to modify the config file for Vanilla in the relevant place, and finally open the port to make the service active.</p>
<p>The final hook we need to write is for other services which may want to consume Vanilla, 'website-relation-joined'.</p>
<pre class="prettyprint">#!/bin/sh

relation-set hostname=`unit-get private-address` port=80
</pre>
<p>Here we can see the other end of the information sharing - in this case <span class="pre">relation-set</span> exposes the given values to the connecting charm. In this case one of the commands is backticked, as <span class="pre">unit-get</span> is another helper command, in this case one which returns the requested value form the machine the charm is running on, specifically here it's IP address.
 So, any connecting charm will be able to ask for the values 'hostname' and 'port'. Remember, once you have finished writing your hooks make sure you 'chmod +x' them.</p>
<p>For our simplistic charm, that is all the hooks we need for the moment, so now we can test it out!</p>
</div>
<span class="number"> 5 </span>
          <div class="step" id="step05">
          <h2>Testing</h2>
          <p>Before we congratulate ourselves too much, we should check that the charm actually works. To help with this, we should open a new terminal window and run the following command:</p>
          <pre>juju debug-log</pre>
          <p>This starts a process to tail the juju log file and show us just exactly what is happening. It won't do much to begin with, but you should see messages appearing when we start to deploy our charm.</p>
          <p>Following our own recipe, in another terminal we should now do the following (assuming you already have a bootstrapped environment):</p>
          <pre>juju deploy mysql
juju deploy --repository=/home/evilnick/localcharms/ local:precise/vanilla
juju add-relation mysql vanilla
juju expose vanilla
</pre>
<p>We used the local deploy options to deploy our charm - substitute the path for your own environment. Everything should now be working away, and your log window will look something like this:</p>

          <img src="./media/author-charm-writing-debug.png" width='600' alt="Step five - debug">  
<p>If you wait for all the Juju operations to finish and run a <span class="pre">juju status</span> command, you will be able to retrieve the public address for the Vanilla forum we just deployed. Copy it into your browser and you should see the setup page (prepopulated with the database config) waiting for any changes. Congratulations!</p>
          <img src="./media/author-charm-writing-vanilla.png" width='600' alt="Step five - vanilla">           

          
          </div>

<span class="number"> 6 </span>
          <div class="step" id="step06">
          <h2>Tidying up</h2>
          <p>With the charm working properly, you may consider everything a job well done. If your charm is really great and you want to share it, particularly on the charm store, then there are a couple of things you ought to add.</p>
          <ol>

          <li>Create a file called 'copyright' and place whatever license information you require in there. </li>
          <li>Add a beautiful icon (<a href="./authors-charm-icon.html">there is a guide to making one here</a>) so others can recognise it in the charm store!</li>
          </ol>
          </div>  
                  
          </article>
        </div>
      </div>
    </section>
    <div class="shadow"></div>
    <footer class="global clearfix" role="contentinfo">
  <div class="row">
    <div class="inner-wrapper">
      <nav role="navigation" class="clearfix">
        <ul class="footer-a">
          <li class="grid-3 first-col">
            <h4><a href="/get-started">Get started</a></h4>
            <ul>
              <li class="page_item page-item-20"><a href="https://juju.ubuntu.com/get-started/local/">Local</a></li>
              <li class="page_item page-item-22"><a href="https://juju.ubuntu.com/get-started/amazon/">Amazon Web Services</a></li>
              <li class="page_item page-item-18"><a href="https://juju.ubuntu.com/get-started/hp-cloud/">HP Cloud</a></li>
              <li class="page_item page-item-16"><a href="https://juju.ubuntu.com/get-started/rackspace/">Rackspace</a></li>
              <li class="page_item page-item-3596"><a href="https://juju.ubuntu.com/get-started/openstack/">Openstack</a></li>
              <li class="page_item page-item-3600"><a href="https://juju.ubuntu.com/get-started/maas/">MAAS</a></li>
            </ul>
          </li>
          <li class="grid-3">
            <h4><a href="/resources">Resources</a></h4>
            <ul>
              <li><a href="http://juju.ubuntu.com/docs">Documentation</a></li>
              <li><a href="/resources/videos/">Videos</a></li>
              <li><a href="http://uistage.jujucharms.com:8080/">Juju GUI demo site</a></li>
            </ul>
          </li>
          <li class="grid-3">
            <h4><a href="/community">Community</a></h4>
            <ul>
              <li class="page_item page-item-28"><a href="https://juju.ubuntu.com/community/juju-blog/">Juju Blog</a></li>
              <li class="page_item page-item-4262"><a href="https://juju.ubuntu.com/community/weekly-charm-meeting/">Weekly Charm Meeting</a></li>
              <li class="page_item page-item-4036"><a href="https://juju.ubuntu.com/community/charmers/">Charmers</a></li>
              <li><a href="https://lists.ubuntu.com/mailman/listinfo/juju">Mailing List</a></li>
              <li><a href="http://webchat.freenode.net/?channels=juju">Chat</a></li>
              <li><a href="http://askubuntu.com/questions/tagged/juju?sort=faq&pagesize=50">FAQ</a></li>
            </ul>
          </li>
          <li class="grid-3 last-col">
            <h4><a href="https://launchpad.net/juju">Code</a></h4>
            <ul>
              <li><a href="https://launchpad.net/juju-core">Juju Core</a></li>
              <li><a href="https://launchpad.net/charms">Charms</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="row no-border">
    <div class="legal inner-wrapper">
      <p>&copy; 2013 Canonical Ltd. Ubuntu and Canonical are registered trademarks of Canonical Ltd.</p>
      <p><a href="https://bugs.launchpad.net/juju-website/+filebug">Report a bug on this site</a></p>
    </div>
  </div>
  <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
</footer>

    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
    <script src="//d38yea5fb4e2oh.cloudfront.net/jquery.stacktack.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
  </body>
</html>
