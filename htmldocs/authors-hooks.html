<!DOCTYPE html> 
<html>
<!--Head-->
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Juju Documentation</title>
		<link href="https://fonts.googleapis.com/css?family=Ubuntu:400,300,300italic,400italic,700,700italic|Ubuntu+Mono" rel="stylesheet" type="text/css">
		<link rel="stylesheet" type="text/css" media="screen" href="http://juju.ubuntu.com/wp-content/themes/juju-website/css/reset.css">
 		<link rel="shortcut icon" href="//assets.ubuntu.com/sites/ubuntu/latest/u/img/favicon.ico" />
		<link rel="stylesheet" type="text/css" media="screen" href="//assets.ubuntu.com/sites/guidelines/css/latest/ubuntu-styles.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="//assets.ubuntu.com/sites/ubuntu/latest/u/css/global.css" />
		<link rel="stylesheet" type="text/css" media="screen" href="http://juju.ubuntu.com/wp-content/themes/juju-website/css/960.css">
		<link rel="stylesheet" type="text/css" media="screen" href="http://juju.ubuntu.com/wp-content/themes/juju-website/css/home-new.css">
		<link rel="stylesheet" id="stacktack-css" href="http://juju.ubuntu.com/wp-content/plugins/stacktack/css/stacktack.min.css?ver=3.4.2" type="text/css" media="all">
		<link href="https://juju.ubuntu.com/docs/css/main.css?1375975745" rel="stylesheet" type="text/css">
		
		<!--[if lt IE 9]>
		<script type="text/javascript" src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
<!--End-Head-->
  <body class="resources">
  	
<!--Header-->

	<header class="banner global" role="banner">
		<nav role="navigation" class="nav-primary nav-right">
			<div class="logo">
				<a class="logo-ubuntu" href="http://juju.ubuntu.com/">
					<img width="118" height="27" src="//assets.ubuntu.com/sites/ubuntu/latest/u/img/logo.png" alt="Juju logo" />
					<span>Juju</span>
				</a>
			</div>
			<ul>
				<li class="accessibility-aid"><a accesskey="s" href="#main-content">Jump to content</a></li>
				<li class="page_item page-item-8"><a href="http://juju.ubuntu.com/charms/">Charms</a></li>
				<li class="page_item page-item-10"><a href="http://juju.ubuntu.com/features/">Features</a></li>
				<li class="page_item page-item-12"><a href="http://juju.ubuntu.com/deployment/">Deployment</a></li>
				<li class="page_item page-item-14"><a href="http://juju.ubuntu.com/resources/">Resources</a></li>
				<li class="page_item page-item-16"><a href="http://juju.ubuntu.com/community/">Community</a></li>
				<li class="page_item page-item-18"><a href="http://juju.ubuntu.comdownload/">Install Juju</a></li>
			</ul>
			<div id="box-search">
				<form class="search-form" method="get" id="searchform" action="http://juju.ubuntu.com/">
					<label class="off-left" for="s">Search:</label>
					<input class="form-text" type="text" value="" name="s" id="s" />
					<button class="off-left form-submit" type="submit" id="searchsubmit">Search</button>
				</form>		
			</div>
		</nav>	
	</header>
<!--End-Header-->

    <section id="content" class="container-12">
      <div class="grid-12 doc-container">
	    <div id="navlinks" class="grid-3 doc-navigation">LINKS</div>
        <div class="grid-9 doc-content">
          <article>
            <section id ="hook-debugging">
            <h1>Hook debugging</h1>
            

            <p class="note"><strong>Note: </strong> Earlier versions of Juju prior to th 1.x.x series had a facility for debugging hooks. This is planned to be reimplemented shortly in the current development series, but is not currently operational, so the examples provided here are for information only.</p> 
            <p>An important facility in any distributed system is the ability to introspect the running system, and to debug it. Within juju the actions performed by the system are executing charm defined hooks. The <span class="pre">debug-log</span> cli provides for inspecting the total state of the system via capturing the logs of all agents and output of all hooks run by the system.</p>
            <p>To facilitate better debugging of hooks, the <tt class="docutils literal"><span class="pre">debug-hooks</span></tt> cli provides for interactive shell usage as a substitute for running a hook. This allows a charm author or system adminstrator the ability to interact with the system in a live environment and either develop or debug a hook.</p>
            
            <h2>How it works</h2>
            <p>When the juju user utilizes the hook debug command like so:</p>
            <pre>juju debug-hooks unit_name [hook_name]</pre>
            
            <p>juju is instructed to replace the execution of the hook from the charm of the respective service unit, and instead to execute it in a shell associated to a tmux session. If no hook name is given, then all hooks will be debugged in this fashion. Multiple hook names can also be specified on the command line. Shell regular expressions can also be utilized to specify hook names.</p>
            <p>The <tt class="docutils literal"><span class="pre">debug-hooks</span></tt> command line invocation will immediately connect to the remote machine of the remote unit and start a named shell connected to the same tmux session there.</p>
            <p>The native capabilities of tmux can be exploited to construct a full debug/development environment on the remote machine.</p>
            <p>When a debugged hook is executed a new named window will pop up in the tmux session with the hook shell started.  The new window's title will match the hook name, and the shell environment will have all the juju environment variables in place, and all of the hook cli API may be utilized (relation-get, relation-set, relation-list, etc.).</p>
            <p>It's important to note that juju serializes hook execution, so while the shell is active, no other hooks will be executed on the unit.  Once the experimentation is done, the user must stop the hook by exiting the shell session.  At this point the system is then free to execute additional hooks.</p>
            <p>It's important to note that any state changes performed while in the hook window via relation-set are buffered till the hook is done executing, in the same way performed for all the relation hooks when running outside of a debug session.</p>
            <p>The debug-hooks can be used to debug the same hook being invoked multiple times as long as the user has not closed the debug screen session.</p>
            <p>The user can exit debug mode by exiting the tmux session (e.g. exiting all shells). The unit will then resume its normal processing.</p>
            
            <h2>Internals</h2>
            <p>Internally the <tt class="docutils literal"><span class="pre">debug-hooks</span></tt> cli begins by verifying its arguments, namely the unit exists, and the named hook is valid for the charm. After that it modifies the zookeeper state of the unit node, setting a flag noting the hook to debug. It then establishes an ssh connection to the machine and executes the tmux command.</p>
            <p>The unit-agent will establish a watch on its own debug settings, on changes introspecting the debug flag, and pass any named hook values down to the hook executor, which will construct debug hook scripts on the fly for matching hooks. These debug hook scripts are responsible for connecting to tmux and monitoring the execution of the hook therein.</p>
            <p>Special care will be taken to ensure the viability of the tmux session and that debug mode is active before creating the interactive hook window in tmux.</p>
            
            
            <h2>Screen vs. tmux</h2>
            <p>Initially juju used GNU screen for the debugging sessions rather than tmux, but tmux turned out to make it easier to avoid race conditions when starting the same session concurrently, as done for the debugging system.  This was the main motivation that prompted the change to tmux.  They both worked very similarly otherwise.</p>
            </section>
          </article>
        </div>
      </div>
    </section>
    <div class="shadow"></div>
<!--Footer-->
	<footer class="global clearfix" role="contentinfo">
		<nav role="navigation">
			<div class="footer-a">
				<div class="clearfix">
					<ul>
						<li>
							<h2><a href="/">Juju</a></h2>
							<ul>
								<li><a href="/charms">Charms</a></li>
								<li><a href="/features">Features</a></li>
								<li><a href="/deployment">Deployment</a></li>
							</ul>
						</li>
						<li>
							<h2><a href="/resources">Resources</a></h2>
							<ul>
								<li><a href="/resources/juju-overview/">Overview</a></li>
								<li><a href="/docs/">Documentation</a></li>
								<li><a href="/resources/the-juju-gui/">The Juju web UI</a></li>
								<li><a href="/docs/authors-charm-store.html">The charm store</a></li>
								<li><a href="/docs/getting-started.html#test">Tutorial</a></li>
								<li><a href="/resources/videos/">Videos</a></li>
								<li><a href="/resources/easy-tasks-for-new-developers/">Easy tasks for new developers</a></li>
							</ul>
						</li>
						<li>
							<h2><a href="/community">Community</a></h2>
							<ul>
								<li><a href="/community/juju-blog/">Juju Blog</a></li>
								<li><a href="/events/">Events</a></li>
								<li><a href="/community/weekly-charm-meeting/">Weekly charm meeting</a></li>
								<li><a href="/community/charmers/">Charmers</a></li>
								<li><a href="/docs/authors-charm-writing.html">Write a charm</a></li>
								<li><a href="/docs/">Help with documentation</a></li>
								<li><a href="/labs/">Juju Labs</a></li>
							</ul>
						</li>
						<li>
							<h2><a href="https://jujucharms.com/sidebar/">Try Juju</a></h2>
							<ul>
								<li><a href="https://jujucharms.com/">Charm store</a></li>
								<li><a href="/download/">Download Juju</a></li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="legal clearfix">
			<p>&copy; 2013 Canonical Ltd. Ubuntu and Canonical are registered trademarks of <a href="http://canonical.com">Canonical Ltd</a>.</p>
		</div>
	</footer>

<!--End-Footer-->

<!--Scripts-->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
    <script src="http://d38yea5fb4e2oh.cloudfront.net/jquery.stacktack.min.js"></script>
    <script type="text/javascript" src="https://juju.ubuntu.com/docs/js/main.js"></script>    
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="//assets.ubuntu.com/sites/ubuntu/latest/u/js/plugins/yui-min.js"></script>
    <script src="//assets.ubuntu.com/sites/ubuntu/latest/u/js/core.js"></script>
    <script src="//assets.ubuntu.com/sites/ubuntu/latest/u/js/global.js"></script>
<!--End-Scripts-->
</body></html>
