
<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Juju Documentation - Relations in Depth</title>
  <link href='https://fonts.googleapis.com/css?family=Ubuntu:400,300,300italic,400italic,700,700italic|Ubuntu+Mono' rel='stylesheet' type='text/css' />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/reset.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/960.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/base.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="//juju.ubuntu.com/wp-content/themes/juju-website/css/home-new.css" />
  <link rel='stylesheet' id='stacktack-css'  href='//juju.ubuntu.com/wp-content/plugins/stacktack/css/stacktack.min.css?ver=3.4.2' type='text/css' media='all' />
  <link href="css/main.css?1375975745" rel="stylesheet" type="text/css"/>

  <!--[if lt IE 9]>
  <script type="text/javascript" src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
  <body class="resources">
    <header class="global clearfix" role="banner">
  <div class="header-navigation">
    <div>
      <nav role="navigation">
        <ul>
          <li class="page_item page-item-6"><a href="https://juju.ubuntu.com/">Home</a></li>
          <li class="page_item page-item-7"><a href="https://juju.ubuntu.com/get-started/">Get started</a></li>
          <li class="page_item page-item-9 current_page_item"><a href="https://juju.ubuntu.com/resources/">Resources</a></li>
          <li class="page_item page-item-13"><a href="https://juju.ubuntu.com/community/">Community</a></li>
          <li class="page_item page-item-3688"><a href="https://juju.ubuntu.com/charm-store/">Charm Store</a></li>
          <li class="page_item page-item-3691"><a href="https://juju.ubuntu.com/events/">Events</a></li>
          <li class="page_item page-item-4474"><a href="https://juju.ubuntu.com/charm-championship/">Charm Championship</a></li>
          <li class="page_item page-item-4249"><a href="https://juju.ubuntu.com/survey/">Survey</a></li>
          <li>
            <form id="form-search" method="get" action="https://juju.ubuntu.com/">
              <fieldset>
                <input id="input-search" type="text" name="s" value="Search" />
              </fieldset>
            </form>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="header-content">
    <div class="clearfix">
      <img src="https://juju.ubuntu.com/wp-content/themes/juju-website/img/arrow-nav.png" width="9" height="5" style="left:455px; display: block;" class="arrow-nav">
      <div class="header-navigation-secondary"></div>
      <div class="header-image"></div>
      <h1>Resources</h1>
      <h2>A collection of some of the most important online references for Juju users and developers.</h2>
    </div>
  </div>
</header>

    <section id="content" class="container-12">
      <div class="grid-12 doc-container">
		<div id="navlinks" class="grid-3 doc-navigation">LINKS</div>
        <div class="grid-9 doc-content">
          <article>
            <section id="relations-in-depth">
            <h1>Relations in depth</h1>

	    <p>A unit's <code>scope</code> consists of the group of units that are transitively connected to that unit within a particular relation. So, for a globally-scoped relation, that means every unit of each service in the relation; for a container-scoped relation, it means only those sets of units which are deployed alongside one another. That is to say: a globally-scoped relation has a single unit scope, whilst a container-scoped relation has one for each principal unit.</p>
	    <p>When a unit becomes aware that it is a member of a relation, its only self- directed action is to <code>join</code> its scope within that relation. This involves two steps:</p>
	    <ul>
            <li>Write initial relation settings (just one value, <code>private-address</code>), to ensure that they will be available to observers before they're triggered by the next step;</li>
	    <li>Signal its existence, and role in the relation, to the rest of the system.</li>
	    </ul>
	    <p>The unit then starts observing and reacting to any other units in its scope which are playing a role in which it is interested. To be specific:</p>
	    <ul>
	    <li>Each provider unit observes every requirer unit</li>
	    <li>Each requirer unit observes every provider unit</li>
	    <li>Each peer unit observes every other peer unit</li>
	    </ul>
	    <p>Now, suppose that some unit as the very first unit to join the relation; and let's say it's a requirer. No provider units are present, so no hooks will fire. But, when a provider unit joins the relation, the requirer and provider become aware of each other almost simultaneously. (Similarly, the first two units in a peer relation become aware of each other almost simultaneously.)</p>
	    <p>So, concurrently, the units on each side of the relation run their relation-joined and relation-changed hooks with respect to their counterpart. The intent is that they communicate appropriate information to each other to set up some sort of connection, by using the relation-set and relation-get hook tools; but neither unit is safe to assume that any particular setting has yet been set by its counterpart.</p>
	    <p>This sounds kinda tricky to deal with, but merely requires suitable respect for the relation-get tool: it is important to realise that relation-get is never <em>guaranteed</em> to contain any values at all, because we have decided that it's perfectly legitimate for a unit to delete its own private-address value. But in normal circumstances, it's reasonable to treat <code>private-address</code> as guaranteed.</p>
	    <p>In one specific kind of hook, this is easy to deal with. A relation-changed hook can always exit without error when the current remote unit is missing data, because the hook is guaranteed to be run again when that data changes -- and, assuming the remote unit is running a charm that agrees on how to implement the interface, the data <em>will</em> change and the hook <em>will</em> be run again.</p>
	    <p>In <em>all</em> other cases -- unit hooks, relation hooks for a different relation, relation hooks for a different remote unit in the same relation, and even relation hooks other than -changed for the <em>same</em> remote unit -- there is no such guarantee. These hooks all run on their own schedule, and there is no reason to expect them to be re-run on a predictable schedule, or in some cases ever again.</p>
	    <p>This means that all such hooks need to be able to handle missing relation data, and to complete successfully; they mustn't fail, because the user is powerless to resolve the situation, and they can't even wait for state to change, because they all see their own sandboxed composite snapshot of fairly-recent state, which never changes.</p>
	    <p>So, outside a vey narrow range of circumstances, relation-get should be treated with particular care. The corresponding advice for relation-set is very simple by comparison: relation-set should be called early and often. Because the unit agent serializes hook execution, there is never any danger of concurrent changes to the data, and so a null setting change can be safely ignored, and will not cause other units to react.</p>
            </section>

            <section id="relations-in-depth">
	    <h2 id="departing-relations">Departing relations</h2>
	    <p>A unit will depart a relation when either the relation or the unit itself is marked for termination. In either case, it follows the same sequence:</p>
	    <ul>
	    <li>For every known related unit -- those which have joined and not yet departed -- run the relation-departed hook.</li>
	    <li>Run the relation-broken hook.</li>
	    <li><code>depart</code> from its scope in the relation.</li>
	    </ul>
	    <p>The unit's eventual departure from its scope will in turn be detected by units of the related service (if they have not already inferred its imminent departure by other means) and cause them to run relation-departed hooks. A unit's relation settings persist beyond its own departure from the relation; the final unit to depart a relation marked for termination is responsible for destroying the relation and all associated data.</p>
            </section>
          </article>
        </div>
      </div>
    </section>
    <div class="shadow"></div>
    <footer class="global clearfix" role="contentinfo">
  <div class="row">
    <div class="inner-wrapper">
      <nav role="navigation" class="clearfix">
        <ul class="footer-a">
          <li class="grid-3 first-col">
            <h4><a href="/get-started">Get started</a></h4>
            <ul>
              <li class="page_item page-item-20"><a href="https://juju.ubuntu.com/get-started/local/">Local</a></li>
              <li class="page_item page-item-22"><a href="https://juju.ubuntu.com/get-started/amazon/">Amazon Web Services</a></li>
              <li class="page_item page-item-18"><a href="https://juju.ubuntu.com/get-started/hp-cloud/">HP Cloud</a></li>
              <li class="page_item page-item-16"><a href="https://juju.ubuntu.com/get-started/rackspace/">Rackspace</a></li>
              <li class="page_item page-item-3596"><a href="https://juju.ubuntu.com/get-started/openstack/">Openstack</a></li>
              <li class="page_item page-item-3600"><a href="https://juju.ubuntu.com/get-started/maas/">MAAS</a></li>
            </ul>
          </li>
          <li class="grid-3">
            <h4><a href="/resources">Resources</a></h4>
            <ul>
              <li><a href="http://juju.ubuntu.com/docs">Documentation</a></li>
              <li><a href="/resources/videos/">Videos</a></li>
              <li><a href="http://uistage.jujucharms.com:8080/">Juju GUI demo site</a></li>
            </ul>
          </li>
          <li class="grid-3">
            <h4><a href="/community">Community</a></h4>
            <ul>
              <li class="page_item page-item-28"><a href="https://juju.ubuntu.com/community/juju-blog/">Juju Blog</a></li>
              <li class="page_item page-item-4262"><a href="https://juju.ubuntu.com/community/weekly-charm-meeting/">Weekly Charm Meeting</a></li>
              <li class="page_item page-item-4036"><a href="https://juju.ubuntu.com/community/charmers/">Charmers</a></li>
              <li><a href="https://lists.ubuntu.com/mailman/listinfo/juju">Mailing List</a></li>
              <li><a href="http://webchat.freenode.net/?channels=juju">Chat</a></li>
              <li><a href="http://askubuntu.com/questions/tagged/juju?sort=faq&pagesize=50">FAQ</a></li>
            </ul>
          </li>
          <li class="grid-3 last-col">
            <h4><a href="https://launchpad.net/juju">Code</a></h4>
            <ul>
              <li><a href="https://launchpad.net/juju-core">Juju Core</a></li>
              <li><a href="https://launchpad.net/charms">Charms</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="row no-border">
    <div class="legal inner-wrapper">
      <p>&copy; 2013 Canonical Ltd. Ubuntu and Canonical are registered trademarks of Canonical Ltd.</p>
      <p><a href="https://bugs.launchpad.net/juju-website/+filebug">Report a bug on this site</a></p>
    </div>
  </div>
</footer>

    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
    <script src="//d38yea5fb4e2oh.cloudfront.net/jquery.stacktack.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
  </body>
</html>
